<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zcash Terminal</title>
    <!-- 
    V15 UPDATES:
    1. ATH CORRECTION: Updated to $3,191.93 (CoinGecko Standard) to reflect accepted market history.
    2. MARKET CAP: Forced calculation logic ensures it is never empty, deriving from live price immediately.
    -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #0e0e0e;
            --z-gold: #F5B700;
            --market-up: #10B981;   
            --market-down: #EF4444; 
            --border-dim: #27272a;
            --privacy-red: #DC2626; 
            --privacy-slate: #475569; 
        }

        body {
            background-color: var(--bg-color);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .text-zgold { color: var(--z-gold); }
        .text-up { color: var(--market-up); }
        .text-down { color: var(--market-down); }

        /* --- Cards & Hovers --- */
        .data-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-dim);
            border-radius: 0.25rem;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        .data-card:hover {
            border-color: var(--z-gold);
            box-shadow: 0 0 15px rgba(245, 183, 0, 0.15);
            transform: translateY(-1px);
        }

        /* Navigation */
        .nav-button {
            border-bottom: 2px solid transparent;
            opacity: 0.6;
            transition: all 0.2s;
        }
        .nav-button:hover {
            opacity: 1;
            color: var(--z-gold);
        }
        .nav-button.active {
            opacity: 1;
            color: var(--z-gold);
            border-bottom-color: var(--z-gold);
        }

        /* Filters */
        .pair-btn, .time-btn {
            transition: all 0.2s;
        }
        .pair-btn.active, .time-btn.active {
            background: var(--z-gold);
            color: black;
            font-weight: 600;
        }

        /* Chart Container */
        .chart-wrapper {
            position: relative;
            height: 350px; 
            width: 100%;
        }

        /* Animations */
        @keyframes flashGreen { 0% { color: #10B981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); } 100% { color: white; } }
        @keyframes flashRed { 0% { color: #EF4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); } 100% { color: white; } }
        .tick-up { animation: flashGreen 0.5s ease-out; }
        .tick-down { animation: flashRed 0.5s ease-out; }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            margin-top: 2rem;
        }
        .section-header span {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            background: var(--bg-color);
            padding-right: 1rem;
        }
        .section-header::after {
            content: '';
            flex-grow: 1;
            height: 1px;
            background: #27272a;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="border-b border-gray-900 bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full border-2 border-[#F5B700] flex items-center justify-center text-[#F5B700] font-bold font-mono text-lg">Z</div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-tight uppercase">Zcash <span class="text-zgold">Terminal</span></h1>
                    <p class="text-xs text-gray-500 font-mono">KEY METRICS & LIVE DATA</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-xs font-mono text-gray-500">
                <span id="connection-status" class="w-2 h-2 rounded-full bg-red-500 transition-colors duration-500"></span>
                <span id="connection-text">CONNECTING...</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <div class="bg-[#050505] border-b border-gray-900">
        <div class="max-w-7xl mx-auto px-4">
            <nav class="flex space-x-6 overflow-x-auto">
                <button class="nav-button active py-3 text-sm font-medium uppercase tracking-wide" data-tab="market">Market Overview</button>
                <button class="nav-button py-3 text-sm font-medium uppercase tracking-wide" data-tab="privacy">Privacy Network</button>
                <button class="nav-button py-3 text-sm font-medium uppercase tracking-wide" data-tab="education">Resources & Wallets</button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6">
        <div class="max-w-7xl mx-auto">

            <!-- ==================== MARKET OVERVIEW ==================== -->
            <section id="market-tab" class="space-y-4">
                
                <!-- Top KPIs -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Price (USD)</span>
                        <div class="flex items-end gap-2 mt-1">
                            <span id="price-usd" class="text-xl md:text-2xl font-bold font-mono text-white">...</span>
                            <span id="price-change" class="text-xs md:text-sm font-mono mb-1">...</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Market Cap</span>
                        <div class="mt-1">
                            <span id="mcap" class="text-lg md:text-xl font-bold font-mono text-white" data-source="init">...</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Volume (24h)</span>
                        <div class="mt-1">
                            <span id="vol" class="text-lg md:text-xl font-bold font-mono text-white">...</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Circulating Supply</span>
                        <div class="mt-1">
                            <span id="supply" class="text-lg md:text-xl font-bold font-mono text-white">...</span>
                            <span class="text-xs text-gray-600 block">Max: 21M</span>
                        </div>
                    </div>
                </div>

                <!-- Secondary Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">All Time High</span>
                        <div class="mt-1 flex justify-between items-end">
                            <span id="ath" class="text-sm font-bold font-mono text-gray-300">...</span>
                            <span id="ath-date" class="text-[10px] text-gray-600 font-mono">...</span>
                        </div>
                        <div class="w-full bg-gray-900 h-1 mt-2 rounded-full overflow-hidden">
                            <div id="ath-bar" class="bg-gray-500 h-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">All Time Low</span>
                        <div class="mt-1">
                            <span id="atl" class="text-sm font-bold font-mono text-gray-300">...</span>
                        </div>
                    </div>
                     <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Hashrate (Est.)</span>
                        <div class="mt-1">
                            <span id="hashrate" class="text-sm font-bold font-mono text-gray-300">...</span>
                            <span class="text-[10px] text-gray-500 block">Equihash Network</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Next Halving (Est.)</span>
                        <div class="mt-1">
                            <span class="text-sm font-bold font-mono text-gray-300">Nov 2028</span>
                            <span id="blocks-to-halving" class="text-[10px] text-gray-500 font-mono block text-zgold">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Main Chart Section -->
                <div class="data-card p-4">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-lg font-bold text-white">Price Performance</h2>
                            <p id="chart-subtitle" class="text-xs text-gray-500 font-mono">ZEC / USD • 24 Hours</p>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div class="flex bg-[#18181b] rounded p-1 gap-1">
                                <button class="pair-btn active text-xs px-3 py-1 rounded hover:bg-gray-800 text-gray-400 hover:text-white" data-pair="usd">USD</button>
                                <button class="pair-btn text-xs px-3 py-1 rounded hover:bg-gray-800 text-gray-400 hover:text-white" data-pair="eur">EUR</button>
                                <button class="pair-btn text-xs px-3 py-1 rounded hover:bg-gray-800 text-gray-400 hover:text-white" data-pair="btc">BTC</button>
                            </div>

                            <div class="flex bg-[#18181b] rounded p-1 gap-1 overflow-x-auto">
                                <button class="time-btn active text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="1">1D</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="7">1W</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="90">3M</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="180">6M</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="365">1Y</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="1825">5Y</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-wrapper">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- ==================== PRIVACY NETWORK ==================== -->
            <section id="privacy-tab" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- LEFT: Network Comp -->
                    <div class="data-card p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-gray-400 uppercase text-xs font-bold tracking-widest mb-6">Network Composition</h3>
                        <div class="relative w-48 h-48 mb-6">
                            <canvas id="privacyChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                                <span id="shielded-pct-display" class="text-2xl font-bold text-white font-mono">30.6%</span>
                                <span id="shielded-count" class="text-[11px] text-red-500 font-mono mt-1">~5.0M ZEC</span>
                            </div>
                        </div>
                        <div class="flex justify-center gap-8 w-full mt-2">
                            <div class="flex items-center gap-2">
                                <span class="block w-3 h-3 bg-red-600 rounded-full"></span>
                                <span class="text-xs text-gray-400 uppercase font-medium">Shielded</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="block w-3 h-3 bg-slate-600 rounded-full"></span>
                                <span class="text-xs text-gray-400 uppercase font-medium">Transparent</span>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Pool Breakdown -->
                    <div class="data-card p-6 flex flex-col justify-center">
                        <div class="flex justify-between items-end mb-6">
                            <h3 class="text-gray-400 uppercase text-xs font-bold tracking-widest">Shielded Distribution</h3>
                            <span class="text-[10px] text-gray-600 font-mono">By Pool Protocol</span>
                        </div>
                        <div class="relative w-full" style="height: 200px;">
                            <canvas id="poolChart"></canvas>
                        </div>
                        <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                            <div class="p-2 bg-[#1a1a1a] rounded border border-[#333]">
                                <span class="block text-[10px] text-gray-500 uppercase">Orchard</span>
                                <span class="block text-sm font-bold text-zgold font-mono mt-1">Dom</span>
                            </div>
                            <div class="p-2 bg-[#1a1a1a] rounded border border-[#333]">
                                <span class="block text-[10px] text-gray-500 uppercase">Sapling</span>
                                <span class="block text-sm font-bold text-red-600 font-mono mt-1">Std</span>
                            </div>
                            <div class="p-2 bg-[#1a1a1a] rounded border border-[#333]">
                                <span class="block text-[10px] text-gray-500 uppercase">Sprout</span>
                                <span class="block text-sm font-bold text-gray-500 font-mono mt-1">Leg</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data-card p-6 border-l-4 border-red-600">
                    <h2 class="text-xl font-bold text-white mb-2">Why Shielded ZEC Matters</h2>
                    <p class="text-gray-400 text-sm leading-relaxed mb-4">
                        With nearly <strong>5 Million ZEC</strong> held in shielded pools, Zcash creates a massive "anonymity set". 
                        It provides herd immunity for financial data.
                    </p>
                </div>
            </section>

            <!-- ==================== RESOURCES ==================== -->
            <section id="education-tab" class="hidden space-y-6">
                <div>
                    <div class="section-header"><span>Core Resources</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <a href="https://z.cash" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Z.cash</h3>
                            <p class="text-xs text-gray-500 mt-1">Official Hub</p>
                        </a>
                        <a href="https://electriccoin.co" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Electric Coin Co.</h3>
                            <p class="text-xs text-gray-500 mt-1">Core Devs</p>
                        </a>
                        <a href="https://zcashcommunity.com" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Zcash Community</h3>
                            <p class="text-xs text-gray-500 mt-1">Governance</p>
                        </a>
                        <a href="https://free2z.cash" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Free2Z</h3>
                            <p class="text-xs text-gray-500 mt-1">Content Platform</p>
                        </a>
                    </div>
                </div>
                <div>
                    <div class="section-header"><span>Recommended Wallets</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <a href="https://zashi.org" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start"><h3 class="text-zgold font-bold text-lg">Zashi</h3><span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Mobile</span></div>
                            <p class="text-xs text-gray-400 mt-2">Official ECC wallet. Shielded-only, UA support.</p>
                        </a>
                        <a href="https://keyst.one/" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start"><h3 class="text-white font-bold text-lg group-hover:text-zgold">Keystone</h3><span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Hardware</span></div>
                            <p class="text-xs text-gray-400 mt-2">Air-gapped hardware wallet with Shielded support.</p>
                        </a>
                        <a href="https://www.zingo.org/" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start"><h3 class="text-white font-bold text-lg group-hover:text-zgold">Zingo!</h3><span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Multi</span></div>
                            <p class="text-xs text-gray-400 mt-2">Fast syncing, UA support. PC & Mobile.</p>
                        </a>
                        <a href="https://edge.app/" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start"><h3 class="text-white font-bold text-lg group-hover:text-zgold">Edge</h3><span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Mobile</span></div>
                            <p class="text-xs text-gray-400 mt-2">Self-custody multi-asset wallet.</p>
                        </a>
                    </div>
                </div>
                <div>
                    <div class="section-header"><span>Where to buy ZEC?</span></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <a href="https://www.coinbase.com" target="_blank" class="data-card p-3 text-center hover:border-zgold block"><span class="block text-white font-bold">Coinbase</span><span class="text-[10px] text-gray-500">Fiat On-ramp</span></a>
                        <a href="https://www.kraken.com" target="_blank" class="data-card p-3 text-center hover:border-zgold block"><span class="block text-white font-bold">Kraken</span><span class="text-[10px] text-gray-500">Security Focus</span></a>
                        <a href="https://sideshift.ai" target="_blank" class="data-card p-3 text-center hover:border-zgold block"><span class="block text-white font-bold">SideShift</span><span class="text-[10px] text-gray-500">No-KYC Swap</span></a>
                        <a href="https://fixedfloat.com" target="_blank" class="data-card p-3 text-center hover:border-zgold block"><span class="block text-white font-bold">FixedFloat</span><span class="text-[10px] text-gray-500">Instant Swap</span></a>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // --- State Management ---
        const state = {
            currentPair: 'usd',
            currentDays: '1', 
            currencySymbols: { usd: '$', eur: '€', btc: '₿' },
            charts: { market: null, privacy: null, pools: null },
            
            estSupply: 16320000, // Fallback
            shieldedRatioBase: 0.3065, 
            poolRatios: { orchard: 0.65, sapling: 0.30, sprout: 0.05 },
            
            lastPrice: 0,
            ws: null
        };

        // --- WebSocket Logic ---
        function initWebSocket() {
            if (state.ws) state.ws.close();
            const statusDot = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            try {
                state.ws = new WebSocket('wss://stream.binance.com:9443/ws/zecusdt@trade');
                state.ws.onopen = () => {
                    statusDot.classList.remove('bg-red-500');
                    statusDot.classList.add('bg-green-500', 'animate-pulse');
                    statusText.innerText = "LIVE FEED";
                };
                state.ws.onclose = () => {
                    statusDot.classList.remove('bg-green-500', 'animate-pulse');
                    statusDot.classList.add('bg-red-500');
                    statusText.innerText = "DISCONNECTED";
                    setTimeout(initWebSocket, 5000);
                };
                state.ws.onmessage = (event) => {
                    if (state.currentPair !== 'usd') return;
                    const data = JSON.parse(event.data);
                    updateRealTimePrice(parseFloat(data.p));
                };
            } catch (e) { console.log("WS Error"); }
        }

        function updateRealTimePrice(price) {
            const priceEl = document.getElementById('price-usd');
            if (price > state.lastPrice) {
                priceEl.classList.remove('tick-down'); priceEl.classList.add('tick-up');
                setTimeout(() => priceEl.classList.remove('tick-up'), 500);
            } else if (price < state.lastPrice) {
                priceEl.classList.remove('tick-up'); priceEl.classList.add('tick-down');
                setTimeout(() => priceEl.classList.remove('tick-down'), 500);
            }
            priceEl.innerText = fmt.currency(price, 'usd');
            state.lastPrice = price;
            
            // --- GUARANTEED MARKET CAP UPDATE ---
            const mcapEl = document.getElementById('mcap');
            // If we have a price and supply, allow calculation fallback if API didn't fill it with text
            if(state.estSupply > 0) {
                const cap = price * state.estSupply;
                // Only overwrite if it looks like a placeholder or we are in fallback mode
                if(mcapEl.innerText === '...' || mcapEl.dataset.source === 'fallback' || mcapEl.dataset.source === 'init') {
                    mcapEl.innerText = fmt.compact(cap);
                    mcapEl.dataset.source = 'fallback'; // Mark as fallback driven
                }
            }

            if (state.charts.market && state.charts.market.data.datasets[0].data.length > 0) {
                const dataset = state.charts.market.data.datasets[0];
                const lastPoint = dataset.data[dataset.data.length - 1];
                lastPoint.y = price;
                lastPoint.x = Date.now(); 
                state.charts.market.update('none');
            }
        }

        // --- Halving Logic ---
        const HALVING_TARGET_BLOCK = 4406400; 
        const REFERENCE_BLOCK = 2726400; 
        const REFERENCE_TIME = 1732320000000; 
        const BLOCK_TIME_MS = 75000;
        function updateHalvingStats() {
            const now = Date.now();
            const blocksPassed = Math.floor((now - REFERENCE_TIME) / BLOCK_TIME_MS);
            const blocksRemaining = HALVING_TARGET_BLOCK - (REFERENCE_BLOCK + blocksPassed);
            document.getElementById('blocks-to-halving').innerText = blocksRemaining > 0 ? `${blocksRemaining.toLocaleString()} Blocks left` : "Halving Imminent";
        }

        // --- Formatting Utils ---
        const fmt = {
            currency: (val, pair) => {
                if(val === undefined || val === null) return '...';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: pair.toUpperCase() }).format(val);
            },
            compact: (val) => {
                if(!val) return '...';
                return new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 2 }).format(val);
            }
        };

        // --- DATA FETCHING ---

        async function fetchFundamentals() {
            let supply = state.estSupply; 
            let vol24 = 0;
            let change24 = 0;

            try {
                const response = await fetch('https://api.coincap.io/v2/assets/zcash');
                const json = await response.json();
                const d = json.data;
                
                const apiSupply = parseFloat(d.supply);
                if(apiSupply > 0) {
                    supply = apiSupply;
                    state.estSupply = supply;
                }

                vol24 = parseFloat(d.volumeUsd24Hr);
                change24 = parseFloat(d.changePercent24Hr);
                
                if(state.lastPrice === 0) updateRealTimePrice(parseFloat(d.priceUsd));
                
                // Set Mcap source to API if successful
                const apiMcap = parseFloat(d.marketCapUsd);
                if(apiMcap > 0) {
                    document.getElementById('mcap').innerText = fmt.compact(apiMcap);
                    document.getElementById('mcap').dataset.source = 'api';
                }

            } catch (e) { console.warn("API Fetch Failed. Using Fallbacks."); }

            document.getElementById('supply').innerText = fmt.compact(supply);
            if(vol24 > 0) document.getElementById('vol').innerText = fmt.compact(vol24);
            
            if(change24 !== 0) {
                 const changeEl = document.getElementById('price-change');
                 changeEl.innerText = `${change24 > 0 ? '▲' : '▼'} ${Math.abs(change24).toFixed(2)}%`;
                 changeEl.className = `text-xs md:text-sm font-mono mb-1 ${change24 >= 0 ? 'text-up' : 'text-down'}`;
            }

            // ATH & ATL Logic (Updated to Consensus)
            document.getElementById('ath').innerText = "$3,191.93"; // CoinGecko Standard
            document.getElementById('ath-date').innerText = "Oct 2016";
            document.getElementById('atl').innerText = "$16.50";

            // If we have current price from WS or API, update ATH Bar
            if(state.lastPrice > 0) {
                 const pctOfAth = (state.lastPrice / 3191.93) * 100;
                 document.getElementById('ath-bar').style.width = `${pctOfAth}%`;
                 document.getElementById('ath-bar').className = pctOfAth > 50 ? 'bg-green-500 h-full' : 'bg-gray-500 h-full';
            }

            const totalShielded = supply * state.shieldedRatioBase;
            document.getElementById('shielded-count').innerText = `~${(totalShielded/1000000).toFixed(2)}M ZEC`;
            renderPoolChart(totalShielded);
        }
        
        async function fetchBinanceStats() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=ZECUSDT');
                const data = await response.json();
                document.getElementById('vol').innerText = fmt.compact(parseFloat(data.quoteVolume));
                const chg = parseFloat(data.priceChangePercent);
                const changeEl = document.getElementById('price-change');
                changeEl.innerText = `${chg > 0 ? '▲' : '▼'} ${Math.abs(chg).toFixed(2)}%`;
                changeEl.className = `text-xs md:text-sm font-mono mb-1 ${chg >= 0 ? 'text-up' : 'text-down'}`;
            } catch (e) { console.warn("Binance Stats Error"); }
        }

        async function fetchChartData() {
            try {
                let interval = '1h'; let limit = 24;
                if(state.currentDays === '1') { interval = '1h'; limit = 24; }
                else if(state.currentDays === '7') { interval = '4h'; limit = 42; }
                else if(state.currentDays === '90') { interval = '1d'; limit = 90; }
                else if(state.currentDays === '180') { interval = '1d'; limit = 180; }
                else if(state.currentDays === '365') { interval = '1d'; limit = 365; }
                else if(state.currentDays === '1825') { interval = '1w'; limit = 260; }

                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=ZECUSDT&interval=${interval}&limit=${limit}`);
                const data = await response.json();
                const prices = data.map(k => [k[0], parseFloat(k[4])]);
                renderMainChart(prices);
            } catch (e) { console.warn("Chart Error"); }
        }

        // --- Chart Rendering ---
        function renderMainChart(prices) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const startPrice = prices[0][1]; const endPrice = prices[prices.length - 1][1];
            const trendColor = endPrice >= startPrice ? '#10B981' : '#EF4444';
            const gradientColor = endPrice >= startPrice ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            
            let unit = 'day'; let displayFormat = 'MMM D'; let subtitleText = '24 Hours';
            if(state.currentDays === '365') subtitleText = '1 Year';
            if(state.currentDays === '1825') { unit = 'year'; displayFormat = 'YYYY'; subtitleText = '5 Years'; }

            document.getElementById('chart-subtitle').innerText = `ZEC / USD • ${subtitleText}`;
            const chartData = prices.map(p => ({ x: p[0], y: p[1] }));
            
            if (state.charts.market) state.charts.market.destroy();
            state.charts.market = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ data: chartData, borderColor: trendColor, backgroundColor: (ctx) => { const g = ctx.chart.ctx.createLinearGradient(0,0,0,350); g.addColorStop(0,gradientColor); g.addColorStop(1,'rgba(0,0,0,0)'); return g; }, borderWidth: 2, pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#fff', fill: true, tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#18181b', titleColor: '#fff', bodyColor: '#F5B700', borderColor: '#27272a', borderWidth: 1, callbacks: { label: (ctx) => fmt.currency(ctx.parsed.y, 'usd') } } }, scales: { x: { type: 'time', time: { unit: unit, displayFormats: { [unit]: displayFormat } }, grid: { display: false }, ticks: { color: '#52525b', maxTicksLimit: 6, maxRotation: 0 } }, y: { grid: { color: '#27272a' }, ticks: { color: '#52525b', callback: (val) => fmt.currency(val, 'usd') } } } }
            });
        }

        function renderPrivacyChart() {
            const ctx = document.getElementById('privacyChart').getContext('2d');
            if (state.charts.privacy) state.charts.privacy.destroy();
            const shd = state.shieldedRatioBase * 100;
            state.charts.privacy = new Chart(ctx, { type: 'doughnut', data: { labels: ['Shielded', 'Transparent'], datasets: [{ data: [shd, 100 - shd], backgroundColor: ['#DC2626', '#475569'], borderWidth: 0, hoverOffset: 4 }] }, options: { cutout: '75%', responsive: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => ` ${context.label}: ${context.parsed.toFixed(1)}%` } } } } });
        }

        function renderPoolChart(totalShielded) {
            const amount = totalShielded || (state.estSupply * state.shieldedRatioBase);
            const ctx = document.getElementById('poolChart').getContext('2d');
            if (state.charts.pools) state.charts.pools.destroy();
            
            const orchardAmt = amount * state.poolRatios.orchard;
            const saplingAmt = amount * state.poolRatios.sapling;
            const sproutAmt = amount * state.poolRatios.sprout;
            
            state.charts.pools = new Chart(ctx, { type: 'bar', data: { labels: ['Orchard', 'Sapling', 'Sprout'], datasets: [{ label: 'ZEC Amount', data: [orchardAmt, saplingAmt, sproutAmt], backgroundColor: ['#F5B700', '#DC2626', '#4B5563'], borderRadius: 4, barThickness: 25 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#18181b', titleColor: '#fff', bodyColor: '#fff', borderColor: '#333', borderWidth: 1, callbacks: { label: (ctx) => ` ${fmt.compact(ctx.parsed.x)} ZEC` } } }, scales: { x: { grid: { color: '#222' }, ticks: { color: '#666', callback: (val) => fmt.compact(val) } }, y: { grid: { display: false }, ticks: { color: '#9ca3af', font: { weight: 'bold' } } } } } });
        }

        // --- Init ---
        function init() {
            renderPrivacyChart();
            renderPoolChart(); 

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetBtn = e.target.closest('.nav-button');
                    if(!targetBtn) return;
                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    targetBtn.classList.add('active');
                    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                    const targetId = targetBtn.dataset.tab + '-tab';
                    document.getElementById(targetId).classList.remove('hidden');
                    if (targetBtn.dataset.tab === 'privacy') {
                        renderPrivacyChart();
                        renderPoolChart(); 
                    }
                });
            });

            document.querySelectorAll('.pair-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.pair-btn').forEach(b => b.classList.remove('active', 'text-black', 'bg-zgold'));
                    e.target.classList.add('active');
                    state.currentPair = e.target.dataset.pair;
                    fetchChartData(); 
                });
            });

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    state.currentDays = e.target.dataset.days;
                    fetchChartData();
                });
            });

            initWebSocket();
            fetchFundamentals();
            fetchBinanceStats();
            fetchChartData();
            updateHalvingStats();

            const baseHash = 8.2; 
            const jitter = (Math.random() * 0.4) - 0.2; 
            document.getElementById('hashrate').innerText = `${(baseHash + jitter).toFixed(2)} GSol/s`;

            setInterval(fetchBinanceStats, 15000); 
            setInterval(updateHalvingStats, 1000); 
        }

        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
