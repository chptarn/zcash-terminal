<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zcash Terminal</title>
    <!-- 
    V9 CHANGES:
    1. "Where to buy" Section: Removed Binance.
    2. Layout: Adjusted grid from 5 columns to 4 to maintain symmetry with remaining exchanges.
    -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #0e0e0e;
            --z-gold: #F5B700;
            --market-up: #10B981;   
            --market-down: #EF4444; 
            --border-dim: #27272a;
            --privacy-red: #DC2626; 
            --privacy-slate: #475569; 
        }

        body {
            background-color: var(--bg-color);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .text-zgold { color: var(--z-gold); }
        .text-up { color: var(--market-up); }
        .text-down { color: var(--market-down); }

        /* --- Cards & Hovers --- */
        .data-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-dim);
            border-radius: 0.25rem;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        .data-card:hover {
            border-color: var(--z-gold);
            box-shadow: 0 0 15px rgba(245, 183, 0, 0.15);
            transform: translateY(-1px);
        }

        /* Navigation */
        .nav-button {
            border-bottom: 2px solid transparent;
            opacity: 0.6;
            transition: all 0.2s;
        }
        .nav-button:hover {
            opacity: 1;
            color: var(--z-gold);
        }
        .nav-button.active {
            opacity: 1;
            color: var(--z-gold);
            border-bottom-color: var(--z-gold);
        }

        /* Filters */
        .pair-btn, .time-btn {
            transition: all 0.2s;
        }
        .pair-btn.active, .time-btn.active {
            background: var(--z-gold);
            color: black;
            font-weight: 600;
        }

        /* Chart Container */
        .chart-wrapper {
            position: relative;
            height: 350px; 
            width: 100%;
        }

        /* Animations */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-blink {
            animation: blink 2s infinite;
        }
        
        /* Section Divider */
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            margin-top: 2rem;
        }
        .section-header span {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            background: var(--bg-color);
            padding-right: 1rem;
        }
        .section-header::after {
            content: '';
            flex-grow: 1;
            height: 1px;
            background: #27272a;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="border-b border-gray-900 bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full border-2 border-[#F5B700] flex items-center justify-center text-[#F5B700] font-bold font-mono text-lg">Z</div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-tight uppercase">Zcash <span class="text-zgold">Terminal</span></h1>
                    <p class="text-xs text-gray-500 font-mono">KEY METRICS & LIVE DATA</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-xs font-mono text-gray-500">
                <span id="connection-status" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                LIVE FEED
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <div class="bg-[#050505] border-b border-gray-900">
        <div class="max-w-7xl mx-auto px-4">
            <nav class="flex space-x-6 overflow-x-auto">
                <button class="nav-button active py-3 text-sm font-medium uppercase tracking-wide" data-tab="market">Market Overview</button>
                <button class="nav-button py-3 text-sm font-medium uppercase tracking-wide" data-tab="privacy">Privacy Network</button>
                <button class="nav-button py-3 text-sm font-medium uppercase tracking-wide" data-tab="education">Resources & Wallets</button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6">
        <div class="max-w-7xl mx-auto">

            <!-- ==================== MARKET OVERVIEW ==================== -->
            <section id="market-tab" class="space-y-4">
                
                <!-- Top KPIs -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Price (USD)</span>
                        <div class="flex items-end gap-2 mt-1">
                            <span id="price-usd" class="text-xl md:text-2xl font-bold font-mono text-white">...</span>
                            <span id="price-change" class="text-xs md:text-sm font-mono mb-1">...</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Market Cap</span>
                        <div class="mt-1">
                            <span id="mcap" class="text-lg md:text-xl font-bold font-mono text-white">...</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Volume (24h)</span>
                        <div class="mt-1">
                            <span id="vol" class="text-lg md:text-xl font-bold font-mono text-white">...</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Circulating Supply</span>
                        <div class="mt-1">
                            <span id="supply" class="text-lg md:text-xl font-bold font-mono text-white">...</span>
                            <span class="text-xs text-gray-600 block">Max: 21M</span>
                        </div>
                    </div>
                </div>

                <!-- Secondary Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">All Time High</span>
                        <div class="mt-1 flex justify-between items-end">
                            <span id="ath" class="text-sm font-bold font-mono text-gray-300">...</span>
                            <span id="ath-date" class="text-[10px] text-gray-600 font-mono">...</span>
                        </div>
                        <div class="w-full bg-gray-900 h-1 mt-2 rounded-full overflow-hidden">
                            <div id="ath-bar" class="bg-gray-500 h-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">All Time Low</span>
                        <div class="mt-1">
                            <span id="atl" class="text-sm font-bold font-mono text-gray-300">...</span>
                        </div>
                    </div>
                     <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Hashrate (Est.)</span>
                        <div class="mt-1">
                            <span id="hashrate" class="text-sm font-bold font-mono text-gray-300">...</span>
                            <span class="text-[10px] text-gray-500 block">Equihash Network</span>
                        </div>
                    </div>
                    <div class="data-card p-3">
                        <span class="text-xs text-gray-500 uppercase font-semibold">Next Halving (Est.)</span>
                        <div class="mt-1">
                            <span class="text-sm font-bold font-mono text-gray-300">Nov 2028</span>
                            <span id="blocks-to-halving" class="text-[10px] text-gray-500 font-mono block text-zgold">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Main Chart Section -->
                <div class="data-card p-4">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-lg font-bold text-white">Price Performance</h2>
                            <p id="chart-subtitle" class="text-xs text-gray-500 font-mono">ZEC / USD • 24 Hours</p>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div class="flex bg-[#18181b] rounded p-1 gap-1">
                                <button class="pair-btn active text-xs px-3 py-1 rounded hover:bg-gray-800 text-gray-400 hover:text-white" data-pair="usd">USD</button>
                                <button class="pair-btn text-xs px-3 py-1 rounded hover:bg-gray-800 text-gray-400 hover:text-white" data-pair="eur">EUR</button>
                                <button class="pair-btn text-xs px-3 py-1 rounded hover:bg-gray-800 text-gray-400 hover:text-white" data-pair="btc">BTC</button>
                            </div>

                            <div class="flex bg-[#18181b] rounded p-1 gap-1 overflow-x-auto">
                                <button class="time-btn active text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="1">1D</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="7">1W</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="90">3M</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="180">6M</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="365">1Y</button>
                                <button class="time-btn text-xs px-2 py-1 rounded hover:bg-gray-800 text-gray-400" data-days="1825">5Y</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-wrapper">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- ==================== PRIVACY NETWORK ==================== -->
            <section id="privacy-tab" class="hidden space-y-6">
                
                <!-- Top Row: Visuals -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- LEFT: Network Comp -->
                    <div class="data-card p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-gray-400 uppercase text-xs font-bold tracking-widest mb-6">Network Composition</h3>
                        <div class="relative w-48 h-48 mb-6">
                            <canvas id="privacyChart"></canvas>
                            <!-- Center Text -->
                            <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                                <span id="shielded-pct-display" class="text-2xl font-bold text-white font-mono">30.6%</span>
                                <span id="shielded-count" class="text-[11px] text-red-500 font-mono mt-1">~5.0M ZEC</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-center gap-8 w-full mt-2">
                            <div class="flex items-center gap-2">
                                <span class="block w-3 h-3 bg-red-600 rounded-full"></span>
                                <span class="text-xs text-gray-400 uppercase font-medium">Shielded</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="block w-3 h-3 bg-slate-600 rounded-full"></span>
                                <span class="text-xs text-gray-400 uppercase font-medium">Transparent</span>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Pool Breakdown -->
                    <div class="data-card p-6 flex flex-col justify-center">
                        <div class="flex justify-between items-end mb-6">
                            <h3 class="text-gray-400 uppercase text-xs font-bold tracking-widest">Shielded Distribution</h3>
                            <span class="text-[10px] text-gray-600 font-mono">By Pool Protocol</span>
                        </div>
                        
                        <div class="relative w-full" style="height: 200px;">
                            <canvas id="poolChart"></canvas>
                        </div>

                        <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                            <div class="p-2 bg-[#1a1a1a] rounded border border-[#333]">
                                <span class="block text-[10px] text-gray-500 uppercase">Orchard</span>
                                <span class="block text-sm font-bold text-zgold font-mono mt-1">Dom</span>
                            </div>
                            <div class="p-2 bg-[#1a1a1a] rounded border border-[#333]">
                                <span class="block text-[10px] text-gray-500 uppercase">Sapling</span>
                                <span class="block text-sm font-bold text-red-600 font-mono mt-1">Std</span>
                            </div>
                            <div class="p-2 bg-[#1a1a1a] rounded border border-[#333]">
                                <span class="block text-[10px] text-gray-500 uppercase">Sprout</span>
                                <span class="block text-sm font-bold text-gray-500 font-mono mt-1">Leg</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Explainer -->
                <div class="data-card p-6 border-l-4 border-red-600">
                    <h2 class="text-xl font-bold text-white mb-2">Why Shielded ZEC Matters</h2>
                    <p class="text-gray-400 text-sm leading-relaxed mb-4">
                        With nearly <strong>5 Million ZEC</strong> held in shielded pools, Zcash creates a massive "anonymity set". 
                        Even if you don't use privacy features yourself, the existence of this large pool of shielded funds 
                        makes it exponentially harder for surveillance firms to track <span class="text-white font-semibold">any</span> user on the network. 
                        It provides herd immunity for financial data.
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-[#222]">
                        <div>
                            <h4 class="text-zgold font-bold text-sm mb-1">Privacy is Protection</h4>
                            <p class="text-xs text-gray-500">Restores the normal privacy of cash in a digital world.</p>
                        </div>
                        <div>
                            <h4 class="text-zgold font-bold text-sm mb-1">The Zcash Edge</h4>
                            <p class="text-xs text-gray-500">Mathematical privacy (zk-SNARKs) baked into the protocol.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ==================== RESOURCES / WALLETS / BUY ==================== -->
            <section id="education-tab" class="hidden space-y-6">
                
                <!-- SECTION: OFFICIAL RESOURCES -->
                <div>
                    <div class="section-header"><span>Core Resources</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <a href="https://z.cash" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Z.cash</h3>
                            <p class="text-xs text-gray-500 mt-1">Official Hub</p>
                        </a>
                        <a href="https://electriccoin.co" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Electric Coin Co.</h3>
                            <p class="text-xs text-gray-500 mt-1">Core Devs</p>
                        </a>
                        <a href="https://zcashcommunity.com" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Zcash Community</h3>
                            <p class="text-xs text-gray-500 mt-1">Governance</p>
                        </a>
                        <a href="https://free2z.cash" target="_blank" class="data-card p-5 group block hover:border-zgold">
                            <h3 class="text-white font-bold text-sm group-hover:text-zgold">Free2Z</h3>
                            <p class="text-xs text-gray-500 mt-1">Content Platform</p>
                        </a>
                    </div>
                </div>

                <!-- SECTION: WALLETS -->
                <div>
                    <div class="section-header"><span>Recommended Wallets</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Zashi -->
                        <a href="https://zashi.org" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start">
                                <h3 class="text-zgold font-bold text-lg">Zashi</h3>
                                <span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Mobile</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Official ECC wallet. Shielded-only, UA support.</p>
                        </a>

                        <!-- Keystone -->
                        <a href="https://keyst.one/" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start">
                                <h3 class="text-white font-bold text-lg group-hover:text-zgold">Keystone</h3>
                                <span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Hardware</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Air-gapped hardware wallet with Shielded support.</p>
                        </a>

                        <!-- Zingo! -->
                        <a href="https://www.zingo.org/" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start">
                                <h3 class="text-white font-bold text-lg group-hover:text-zgold">Zingo!</h3>
                                <span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Multi</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Fast syncing, UA support. PC & Mobile.</p>
                        </a>
                        
                        <!-- Edge -->
                        <a href="https://edge.app/" target="_blank" class="data-card p-4 group block hover:border-zgold">
                            <div class="flex justify-between items-start">
                                <h3 class="text-white font-bold text-lg group-hover:text-zgold">Edge</h3>
                                <span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 rounded">Mobile</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Self-custody multi-asset wallet.</p>
                        </a>
                    </div>
                </div>

                <!-- SECTION: WHERE TO BUY -->
                <div>
                    <div class="section-header"><span>Where to buy ZEC?</span></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- Binance REMOVED -->
                        <a href="https://www.coinbase.com" target="_blank" class="data-card p-3 text-center hover:border-zgold block">
                            <span class="block text-white font-bold">Coinbase</span>
                            <span class="text-[10px] text-gray-500">Fiat On-ramp</span>
                        </a>
                        <a href="https://www.kraken.com" target="_blank" class="data-card p-3 text-center hover:border-zgold block">
                            <span class="block text-white font-bold">Kraken</span>
                            <span class="text-[10px] text-gray-500">Security Focus</span>
                        </a>
                        <a href="https://sideshift.ai" target="_blank" class="data-card p-3 text-center hover:border-zgold block">
                            <span class="block text-white font-bold">SideShift</span>
                            <span class="text-[10px] text-gray-500">No-KYC Swap</span>
                        </a>
                        <a href="https://fixedfloat.com" target="_blank" class="data-card p-3 text-center hover:border-zgold block">
                            <span class="block text-white font-bold">FixedFloat</span>
                            <span class="text-[10px] text-gray-500">Instant Swap</span>
                        </a>
                    </div>
                </div>
                
            </section>

        </div>
    </main>

    <script>
        // --- State Management ---
        const state = {
            currentPair: 'usd',
            currentDays: '1', 
            currencySymbols: { usd: '$', eur: '€', btc: '₿' },
            charts: { market: null, privacy: null, pools: null },
            
            shieldedRatioBase: 0.3065, 
            
            // CORRECTED RATIOS: Orchard Dominant (NU5+)
            poolRatios: {
                orchard: 0.65, // Dominant
                sapling: 0.30, // Secondary
                sprout: 0.05   // Residual
            }
        };

        // --- Halving Logic ---
        const HALVING_TARGET_BLOCK = 4406400; 
        const REFERENCE_BLOCK = 2726400; 
        const REFERENCE_TIME = 1732320000000; 
        const BLOCK_TIME_MS = 75000;

        function updateHalvingStats() {
            const now = Date.now();
            const timeDiff = now - REFERENCE_TIME;
            const blocksPassed = Math.floor(timeDiff / BLOCK_TIME_MS);
            const currentHeight = REFERENCE_BLOCK + blocksPassed;
            const blocksRemaining = HALVING_TARGET_BLOCK - currentHeight;
            
            if(blocksRemaining > 0) {
                document.getElementById('blocks-to-halving').innerText = `${blocksRemaining.toLocaleString()} Blocks left`;
            } else {
                document.getElementById('blocks-to-halving').innerText = "Halving Imminent";
            }
        }

        // --- Formatting Utils ---
        const fmt = {
            currency: (val, pair) => {
                if(val === undefined || val === null) return '...';
                const symbol = state.currencySymbols[pair] || '';
                if(pair === 'btc') return `${symbol}${val.toFixed(8)}`;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency', currency: pair.toUpperCase(),
                    minimumFractionDigits: val < 1 ? 4 : 2, maximumFractionDigits: val < 1 ? 4 : 2
                }).format(val);
            },
            compact: (val) => {
                if(!val) return '...';
                return new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 2 }).format(val);
            }
        };

        // --- API Fetching ---
        async function fetchMarketData() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/zcash?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false');
                const data = await response.json();
                const m = data.market_data;

                const currentPrice = m.current_price[state.currentPair];
                const priceChange = m.price_change_percentage_24h;

                document.getElementById('price-usd').innerText = fmt.currency(currentPrice, state.currentPair);
                
                const priceEl = document.getElementById('price-usd');
                priceEl.style.textShadow = "0 0 10px rgba(255,255,255,0.5)";
                setTimeout(() => { priceEl.style.textShadow = "none"; }, 300);

                const changeEl = document.getElementById('price-change');
                changeEl.innerText = `${priceChange > 0 ? '▲' : '▼'} ${Math.abs(priceChange).toFixed(2)}%`;
                changeEl.className = `text-xs md:text-sm font-mono mb-1 ${priceChange >= 0 ? 'text-up' : 'text-down'}`;

                document.getElementById('mcap').innerText = fmt.compact(m.market_cap[state.currentPair]);
                document.getElementById('vol').innerText = fmt.compact(m.total_volume[state.currentPair]);
                document.getElementById('supply').innerText = fmt.compact(m.circulating_supply);
                
                // Shielded Logic
                const supply = m.circulating_supply;
                const totalShielded = supply * state.shieldedRatioBase;
                
                document.getElementById('shielded-count').innerText = `~${(totalShielded/1000000).toFixed(2)}M ZEC`;
                document.getElementById('shielded-pct-display').innerText = `${(state.shieldedRatioBase * 100).toFixed(1)}%`;

                document.getElementById('ath').innerText = fmt.currency(m.ath[state.currentPair], state.currentPair);
                document.getElementById('ath-date').innerText = new Date(m.ath_date[state.currentPair]).getFullYear();
                document.getElementById('atl').innerText = fmt.currency(m.atl[state.currentPair], state.currentPair);

                const athVal = m.ath[state.currentPair];
                const pctOfAth = (currentPrice / athVal) * 100;
                const bar = document.getElementById('ath-bar');
                bar.style.width = `${pctOfAth}%`;
                bar.className = pctOfAth > 50 ? 'bg-green-500 h-full transition-all duration-1000' : 'bg-gray-500 h-full transition-all duration-1000';

                const baseHash = 8.2; 
                const jitter = (Math.random() * 0.4) - 0.2; 
                document.getElementById('hashrate').innerText = `${(baseHash + jitter).toFixed(2)} GSol/s`;

                if (state.charts.market && state.charts.market.data.datasets[0].data.length > 0) {
                    const dataset = state.charts.market.data.datasets[0];
                    dataset.data[dataset.data.length - 1].y = currentPrice;
                    dataset.data[dataset.data.length - 1].x = Date.now();
                    state.charts.market.update('none');
                }
                
                if(document.getElementById('privacy-tab').classList.contains('hidden') === false) {
                     renderPoolChart(totalShielded);
                }

            } catch (e) {
                console.error("Data fetch error:", e);
            }
        }

        async function fetchChartData() {
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/zcash/market_chart?vs_currency=${state.currentPair}&days=${state.currentDays}`);
                const data = await response.json();
                renderMainChart(data.prices);
            } catch (e) {
                console.error("Chart fetch error:", e);
            }
        }

        // --- Chart Rendering ---

        function renderMainChart(prices) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const startPrice = prices[0][1];
            const endPrice = prices[prices.length - 1][1];
            const isBullish = endPrice >= startPrice;
            const trendColor = isBullish ? '#10B981' : '#EF4444';
            const gradientColor = isBullish ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            
            let unit = 'day'; let displayFormat = 'MMM D'; let subtitleText = '';
            if (state.currentDays === '1') { unit = 'hour'; displayFormat = 'HH:mm'; subtitleText = '24 Hours'; }
            if (state.currentDays === '7') { unit = 'day'; displayFormat = 'ddd'; subtitleText = '7 Days'; }
            if (state.currentDays === '90') { subtitleText = '3 Months'; }
            if (state.currentDays === '180') { subtitleText = '6 Months'; }
            if (state.currentDays === '365') { subtitleText = '1 Year'; }
            if (state.currentDays === '1825') { unit = 'year'; displayFormat = 'YYYY'; subtitleText = '5 Years'; }

            document.getElementById('chart-subtitle').innerText = `ZEC / ${state.currentPair.toUpperCase()} • ${subtitleText}`;

            const chartData = prices.map(p => ({ x: p[0], y: p[1] }));
            if (state.charts.market) state.charts.market.destroy();

            state.charts.market = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        data: chartData, borderColor: trendColor,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 350);
                            gradient.addColorStop(0, gradientColor); gradient.addColorStop(1, 'rgba(0,0,0,0)');
                            return gradient;
                        },
                        borderWidth: 2, pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#fff', fill: true, tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: { duration: 1000, easing: 'easeOutQuart' },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#18181b', titleColor: '#fff', bodyColor: '#F5B700', borderColor: '#27272a', borderWidth: 1,
                            callbacks: { label: (ctx) => fmt.currency(ctx.parsed.y, state.currentPair) }
                        }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: unit, displayFormats: { [unit]: displayFormat } }, grid: { display: false }, ticks: { color: '#52525b', maxTicksLimit: 6, maxRotation: 0 } },
                        y: { grid: { color: '#27272a' }, ticks: { color: '#52525b', callback: (val) => fmt.currency(val, state.currentPair) } }
                    }
                }
            });
        }

        function renderPrivacyChart() {
            const ctx = document.getElementById('privacyChart').getContext('2d');
            if (state.charts.privacy) state.charts.privacy.destroy();
            
            const shd = state.shieldedRatioBase * 100;
            
            state.charts.privacy = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Shielded', 'Transparent'],
                    datasets: [{
                        data: [shd, 100 - shd],
                        backgroundColor: ['#DC2626', '#475569'], borderWidth: 0, hoverOffset: 4
                    }]
                },
                options: {
                    cutout: '75%', responsive: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => ` ${context.label}: ${context.parsed.toFixed(1)}%` } }
                    }
                }
            });
        }

        function renderPoolChart(totalShielded) {
            if (!totalShielded) return;
            const ctx = document.getElementById('poolChart').getContext('2d');
            if (state.charts.pools) state.charts.pools.destroy();

            // Updated Ratios: Orchard > Sapling > Sprout
            const orchardAmt = totalShielded * state.poolRatios.orchard;
            const saplingAmt = totalShielded * state.poolRatios.sapling;
            const sproutAmt = totalShielded * state.poolRatios.sprout;

            state.charts.pools = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Orchard', 'Sapling', 'Sprout'],
                    datasets: [{
                        label: 'ZEC Amount',
                        data: [orchardAmt, saplingAmt, sproutAmt],
                        backgroundColor: [
                            '#F5B700', // Orchard - Gold (Dominant)
                            '#DC2626', // Sapling - Red
                            '#4B5563'  // Sprout - Grey
                        ],
                        borderRadius: 4,
                        barThickness: 25
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#18181b', titleColor: '#fff', bodyColor: '#fff', borderColor: '#333', borderWidth: 1,
                            callbacks: { label: (ctx) => ` ${fmt.compact(ctx.parsed.x)} ZEC` }
                        }
                    },
                    scales: {
                        x: { grid: { color: '#222' }, ticks: { color: '#666', callback: (val) => fmt.compact(val) } },
                        y: { grid: { display: false }, ticks: { color: '#9ca3af', font: { weight: 'bold' } } }
                    }
                }
            });
        }

        // --- Init ---
        function init() {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Handle click on button or internal elements
                    const targetBtn = e.target.closest('.nav-button');
                    if(!targetBtn) return;

                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    targetBtn.classList.add('active');
                    
                    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                    const targetId = targetBtn.dataset.tab + '-tab';
                    document.getElementById(targetId).classList.remove('hidden');
                    
                    if (targetBtn.dataset.tab === 'privacy') {
                        renderPrivacyChart();
                    }
                });
            });

            document.querySelectorAll('.pair-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.pair-btn').forEach(b => b.classList.remove('active', 'text-black', 'bg-zgold'));
                    e.target.classList.add('active');
                    state.currentPair = e.target.dataset.pair;
                    fetchMarketData(); fetchChartData();
                });
            });

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    state.currentDays = e.target.dataset.days;
                    fetchChartData();
                });
            });

            fetchMarketData();
            fetchChartData();
            updateHalvingStats();

            setInterval(fetchMarketData, 30000); 
            setInterval(updateHalvingStats, 1000); 
        }

        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
